@page "/games";

<PageTitle>Games</PageTitle>

@using GameTracker.Frontend.Models;
@using GameTracker.Frontend.Pages.Components;
@using GameTracker.Interfaces;
@using GameTracker.Core;
@using GameTracker.Models;
@using GameTracker.Models.Enums;

@inject NavigationManager NavigationManager;
@inject PreloadService PreloadService;
@inject ToastService ToastService;

@inject IGameLibraryManager GameLibraryManager;

@if (!_isAuthenticated)
{
    <p><em>Unauthorized.</em></p>
}
else if (_isInitializing)
{
}
else if (GameLibraryManager.Games == null || !GameLibraryManager.Games.Any())
{
    <p><em>No games loaded. Please configure a game provider.</em></p>
}
else
{
    <table class="table">
        <tr>
            <td>
                <Accordion>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Search" Class="me-1" />Title Search
                        </TitleTemplate>
                        <Content>
                            <AutoComplete @bind-Value="_filterProperties.Name"
                                          TItem="Game"
                                          DataProvider="GameFilterProvider"
                                          PropertyName="Title"
                                          Placeholder="Search for a game title..."
                                          OnChanged="(Game game) => OnAutoComplete(game)" />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Calendar" Class="me-1" /> Released Since...
                        </TitleTemplate>
                        <Content>
                            <DateInput TValue="DateOnly?" @bind-Value="@ReleaseDateFilter" Placeholder="Released since..." />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Hourglass" Class="me-1" /> Time Played...
                        </TitleTemplate>
                        <Content>
                            <NumberInput TValue="int?" @bind-Value="@UpperHoursFilter" Placeholder="Upper bound (hours)" />
                            <NumberInput TValue="int?" @bind-Value="@LowerHoursFilter" Placeholder="Lower bound (hours)" />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Star" Class="me-1" /> Minimum Review Score...
                        </TitleTemplate>
                        <Content>
                            <NumberInput TValue="int?" @bind-Value="@MinimumReviewScoreFilter" Placeholder="Minimum score (%)" />
                        </Content>
                    </AccordionItem>
                </Accordion>
            </td>
            <td>
                <Accordion>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.CodeSlash" Class="me-1"/> Studio Search...
                        </TitleTemplate>
                        <Content>
                            <AutoComplete @bind-Value="_filterProperties.Studio"
                                          TItem="Studio"
                                          DataProvider="StudioFilterProvider"
                                          PropertyName="Name"
                                          Placeholder="Search for a development studio..."
                                          OnChanged="(Studio studio) => OnAutoComplete(studio)" />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Building" Class="me-1" /> Publisher Search...
                        </TitleTemplate>
                        <Content>
                            <AutoComplete @bind-Value="_filterProperties.Publisher"
                                          TItem="Publisher"
                                          DataProvider="PublisherFilterProvider"
                                          PropertyName="Name"
                                          Placeholder="Search for a publisher..."
                                          OnChanged="(Publisher publisher) => OnAutoComplete(publisher)" />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Clock" Class="me-1" /> Last Played...
                        </TitleTemplate>
                        <Content>
                            <DateInput TValue="DateTime?" @bind-Value="@LastPlayedFilter" Placeholder="Not played after..." />
                        </Content>
                    </AccordionItem>
                    <AccordionItem>
                        <TitleTemplate>
                            <Icon Name="IconName.Controller" Class="me-1" /> Genre Search...
                        </TitleTemplate>
                        <Content>
                            <AutoComplete @bind-Value="_filterProperties.Genre"
                                          TItem="FilterableGenre"
                                          DataProvider="GenreFilterProvider"
                                          PropertyName="Name"
                                          Placeholder="Search for a genre..."
                                          OnChanged="(FilterableGenre genre) => OnAutoComplete(genre)" />
                        </Content>
                    </AccordionItem>
                </Accordion>
            </td>
        </tr>
    </table>

    <Grid AllowFiltering="false"
          AllowPaging="true"
          Class="table table-hover table-bordered table-striped"
          Data="GameRows"
          GridSettingsChanged="OnGridUpdated"
          PageSize="@_pageSize"
          PageSizeSelectorVisible="true"
          PageSizeSelectorItems="@(new int[] { 4,8,16 })"
          PaginationItemsTextFormat="@_paginationText"
          Responsive="true"
          TItem="GameRow">
        <GridColumn TItem="GameRow" PropertyName="Game1" Filterable="false" Sortable="false">
            <ChildContent>
                <GameCell Game="@context.Game1" />
            </ChildContent>
        </GridColumn>
        <GridColumn TItem="GameRow" PropertyName="Game2" Filterable="false" Sortable="false">
            <ChildContent>
                <GameCell Game="@context.Game2" />
            </ChildContent>
        </GridColumn>
        <GridColumn TItem="GameRow" PropertyName="Game3" Filterable="false" Sortable="false">
            <ChildContent>
                <GameCell Game="@context.Game3" />
            </ChildContent>
        </GridColumn>
    </Grid>
}

@code {

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private FilterProperties _filterProperties = new();
    private bool _isAuthenticated;
    private bool _isInitializing;
    private int _pageSize;
    private string _paginationText;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;
        _isAuthenticated = authState?.User?.Identity?.IsAuthenticated ?? false;
        var userName = authState?.User?.Identity?.Name;

        if (!_isAuthenticated || string.IsNullOrEmpty(userName))
        {
            return;
        }

        _isInitializing = true;
        PreloadService.Show();
        await GameLibraryManager.InitialiseProviders(userName);
        PreloadService.Hide();
        _isInitializing = false;

        _pageSize = 4;
        _paginationText = $"1 to 12 of {FilteredGames.Count} games";
    }

    private async Task<AutoCompleteDataProviderResult<Game>> GameFilterProvider(AutoCompleteDataProviderRequest<Game> request)
    {
        return await Task.FromResult(request.ApplyTo(GameLibraryManager.Games));
    }

    private async Task<AutoCompleteDataProviderResult<FilterableGenre>> GenreFilterProvider(AutoCompleteDataProviderRequest<FilterableGenre> request)
    {
        var genres = GameLibraryManager.Games.SelectMany(g => g.Genres)
            .Distinct()
            .Select(g => new FilterableGenre { Name = g.ToString() })
            .ToList();

        return await Task.FromResult(new AutoCompleteDataProviderResult<FilterableGenre>
        {
            Data = genres,
            TotalCount = genres.Count()
        });
    }

    private async Task<AutoCompleteDataProviderResult<Publisher>> PublisherFilterProvider(AutoCompleteDataProviderRequest<Publisher> request)
    {
        var publishers = GameLibraryManager.Games.Where(g => g.Publisher != null).Select(g => g.Publisher).DistinctBy(p => p.Name);
        return await Task.FromResult(new AutoCompleteDataProviderResult<Publisher>
        {
            Data = publishers,
            TotalCount = publishers.Count()
        });
    }

    private async Task<AutoCompleteDataProviderResult<Studio>> StudioFilterProvider(AutoCompleteDataProviderRequest<Studio> request)
    {
        var studios = GameLibraryManager.Games.Where(g => g.Studio != null).Select(g => g.Studio).DistinctBy(p => p.Name);
        return await Task.FromResult(new AutoCompleteDataProviderResult<Studio>
        {
            Data = studios,
            TotalCount = studios.Count()
        });
    }

    private List<Game> FilteredGames
    {
        get
        {
            var filteredGames = new List<Game>(GameLibraryManager.Games);

            if (!string.IsNullOrEmpty(_filterProperties.Name))
            {
                filteredGames = filteredGames.Where(g => g.Title.Contains(_filterProperties.Name)).ToList();
            }

            if (!string.IsNullOrEmpty(_filterProperties.Studio))
            {
                filteredGames = filteredGames.Where(g => g.StudioName != null && g.StudioName.Contains(_filterProperties.Studio)).ToList();
            }

            if (!string.IsNullOrEmpty(_filterProperties.Publisher))
            {
                filteredGames = filteredGames.Where(g => g.PublisherName != null && g.PublisherName.Contains(_filterProperties.Publisher)).ToList();
            }

            if (!string.IsNullOrEmpty(_filterProperties.Genre))
            {
                filteredGames = filteredGames.Where(g => g.Genres != null && g.Genres.Any(g => g.ToString() == _filterProperties.Genre)).ToList();
            }

            if (_filterProperties.ReleaseDate != null)
            {
                var filterDateTime = new DateTime(_filterProperties.ReleaseDate.Value.Year, _filterProperties.ReleaseDate.Value.Month, _filterProperties.ReleaseDate.Value.Day);
                filteredGames = filteredGames.Where(g => g.ReleaseDate.HasValue && g.ReleaseDate.Value >= filterDateTime).ToList();
            }

            if (_filterProperties.LastPlayed != null)
            {
                filteredGames = filteredGames.Where(g => g.LastPlayed.HasValue && g.LastPlayed.Value <= _filterProperties.LastPlayed).ToList();
            }

            if (_filterProperties.LowerHours != null)
            {
                var lower = TimeSpan.FromHours(_filterProperties.LowerHours.Value);                
                filteredGames = filteredGames.Where(g => g.Playtime != null && g.Playtime >= lower).ToList();
            }

            if (_filterProperties.UpperHours != null)
            {
                var upper = TimeSpan.FromHours(_filterProperties.UpperHours.Value);
                filteredGames = FilteredGames.Where(g => g.Playtime != null && g.Playtime <= upper).ToList();
            }

            if (_filterProperties.MinimumReviewScore != null)
            {
                filteredGames = filteredGames.Where(g => g.AverageCriticalReview.HasValue && g.AverageCriticalReview > _filterProperties.MinimumReviewScore).ToList();
            }

            return filteredGames;
        }
    }

    private List<GameRow> GameRows
    {
        get
        {
            return FilteredGames.Chunk(3).Select(c => new GameRow
                {
                    Game1 = c[0],
                    Game2 = c.Length >= 2 ? c[1] : null,
                    Game3 = c.Length >= 3 ? c[2] : null
                }).ToList();
        }
    }

    private DateOnly? ReleaseDateFilter
    {
        get => _filterProperties.ReleaseDate;
        set
        {
            _filterProperties.ReleaseDate = value;
            this.StateHasChanged();
        }
    }

    private DateTime? LastPlayedFilter
    {
        get => _filterProperties.LastPlayed;
        set
        {
            _filterProperties.LastPlayed = value;
            this.StateHasChanged();
        }
    }

    private int? LowerHoursFilter
    {
        get => _filterProperties.LowerHours;
        set
        {
            _filterProperties.LowerHours = value;
            this.StateHasChanged();
        }
    }

    private int? UpperHoursFilter
    {
        get => _filterProperties.UpperHours;
        set
        {
            _filterProperties.UpperHours = value;
            this.StateHasChanged();
        }
    }

    private int? MinimumReviewScoreFilter
    {
        get => _filterProperties.MinimumReviewScore;
        set
        {
            _filterProperties.MinimumReviewScore = value;
            this.StateHasChanged();
        }
    }

    private void OnAutoComplete(object state)
    {
        if (state != null)
        {
            this.StateHasChanged();
        }        
    }

    private async Task OnGridUpdated(GridSettings gridSettings)
    {       
        int from = (gridSettings.PageNumber - 1) * (gridSettings.PageSize * 3) + 1;
        int to = gridSettings.PageNumber * (gridSettings.PageSize * 3);
        int total = FilteredGames.Count;

        if (to > total)
        {
            to = total;
        }

        _pageSize = gridSettings.PageSize;
        _paginationText = $"{from} to {to} of {total} games";
    }
}