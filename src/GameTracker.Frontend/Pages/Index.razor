@page "/"
@using GameTracker.Interfaces;

@inject IGameLibraryManager GameLibraryManager;

<PageTitle>Game Tracker</PageTitle>

@if (!_isAuthenticated)
{
    <span>Please log in to configure your game library.</span>
}
else if (_isInitializing)
{
    <PlaceholderContainer Animation="PlaceholderAnimation.Glow">
        <Placeholder Width="PlaceholderWidth.Col7" />
        <Placeholder Width="PlaceholderWidth.Col9" />
        <Placeholder Width="PlaceholderWidth.Col6" />
    </PlaceholderContainer>
}
else
{
    <h1>Welcome, @_userName!</h1>
    <p>Your library contains @GameLibraryManager.GamesGroupedByTitle.Count().ToString("N0") titles (with @GetDuplicateCount() duplicates) from @GameLibraryManager.InitialisedProviders providers.</p>
    <p>You have played ~@GetHoursPlayed() hours across all titles over the last ~@GetYearsSinceEarliestPlayedTitle() years.</p>
    <p>Please select an option from the left menu.</p>
}


@code {

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    private bool _isAuthenticated;
    private bool _isInitializing;
    private string? _userName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        _isAuthenticated = authState?.User?.Identity?.IsAuthenticated ?? false;
        _userName = authState?.User?.Identity?.Name;

        if (_isAuthenticated)
        {
            _isInitializing = true;
            await GameLibraryManager.InitialiseProviders(_userName);
            _isInitializing = false;
        }
    }

    private int GetDuplicateCount()
    {
        return GameLibraryManager.GamesGroupedByTitle.Where(gg => gg.Count() > 1 && gg.DistinctBy(g => g.ProviderName).Count() > 1).Count();
    }

    private string GetHoursPlayed()
    {
        return TimeSpan.FromMilliseconds(GameLibraryManager.Games.Where(g => g.Playtime != null)
                                                                 .Sum(g => g.Playtime.Value.TotalMilliseconds)).TotalHours
                                                                 .ToString("N0");
    }

    private string GetYearsSinceEarliestPlayedTitle()
    {
        return ((DateTime.Now - GameLibraryManager.Games.Where(g => g.LastPlayed != null && g.LastPlayed > DateTime.UnixEpoch.AddDays(5))
                                                        .Min(g => g.LastPlayed.Value)).TotalDays / 365)
                                                        .ToString("F");
    }
}